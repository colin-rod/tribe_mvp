name: CI

on:
  push:
    branches:
      - main
      - development
  pull_request:

permissions:
  contents: read

env:
  CI: true
  NODE_ENV: test
  NEXT_PUBLIC_SUPABASE_URL: https://placeholder.supabase.co
  NEXT_PUBLIC_SUPABASE_ANON_KEY: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBsYWNlaG9sZGVyIiwicm9sZSI6ImFub24iLCJpYXQiOjE2NDU0ODYzOTIsImV4cCI6MTk2MTA2MjM5Mn0.placeholder-test-key-for-ci-builds-only
  NEXT_PUBLIC_APP_URL: http://localhost:3000
  SENDGRID_API_KEY: SG.placeholder-sendgrid-ci-key
  SENDGRID_FROM_EMAIL: ci@example.com
  SENDGRID_FROM_NAME: Tribe CI
  SUPABASE_SERVICE_ROLE_KEY: service-role-ci-key
  DATABASE_URL: postgres://postgres:postgres@localhost:5432/postgres
  NEXTAUTH_SECRET: 0123456789abcdefghijklmnopqrstuv
  NEXTAUTH_URL: http://localhost:3000

jobs:
  lint-test-build:
    runs-on: ubuntu-latest
    steps:
      - name: Check out repository
        uses: actions/checkout@v6

      - name: Set up Node.js
        uses: actions/setup-node@v6
        with:
          node-version: 20
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: Security audit
        run: npm audit --audit-level=moderate

      - name: Run lint checks
        run: npm run lint

      - name: Run type checks
        run: npm run type-check

      - name: Check color contrast (WCAG AA)
        run: npm run check:contrast

      - name: Run unit tests
        run: npm run test:ci

      - name: Run accessibility tests
        run: npm run test:a11y

      - name: Build application
        run: npm run build

  visual-regression:
    runs-on: ubuntu-latest
    steps:
      - name: Check out repository
        uses: actions/checkout@v6

      - name: Set up Node.js
        uses: actions/setup-node@v6
        with:
          node-version: 20
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: Install Playwright browsers
        run: npx playwright install --with-deps chromium

      - name: Run visual regression tests
        run: npm run test:visual
        env:
          CI: true

      - name: Upload test report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: playwright-report
          path: playwright-report/
          retention-days: 30

      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: visual-test-results
          path: test-results/
          retention-days: 30
