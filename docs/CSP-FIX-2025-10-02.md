# Content Security Policy (CSP) Fix - October 2, 2025

## Issue

The application was experiencing CSP errors in production due to Next.js 15 requiring inline scripts for hydration, but the CSP configuration was only allowing `'unsafe-inline'` in development mode.

### Errors Observed

```
Content-Security-Policy: The page's settings blocked an inline script (script-src-elem)
from being executed because it violates the following directive:
"script-src 'self' https://va.vercel-scripts.com https://www.googletagmanager.com https://www.google-analytics.com"
```

Additional issues:
- Vercel Live scripts were blocked
- WebSocket connections for dev tools were blocked
- Favicon 404 error

## Root Cause

1. **Next.js 15 Hydration**: Next.js 15 uses inline scripts for client-side hydration, which requires `'unsafe-inline'` in the `script-src` directive even in production.

2. **Vercel Services**: Vercel Live feedback tool and analytics services were not properly whitelisted.

3. **Missing Favicon**: No favicon.ico file was present, causing 404 errors.

## Solution

### 1. Updated CSP Configuration

**File**: [`src/lib/security/csp.ts`](../src/lib/security/csp.ts)

**Changes**:

```typescript
// Before
'script-src': [
  "'self'",
  isDevelopment ? "'unsafe-inline'" : '',  // Only in dev
  isDevelopment ? "'unsafe-eval'" : '',
  'https://va.vercel-scripts.com',
  'https://www.googletagmanager.com',
  'https://www.google-analytics.com'
].filter(Boolean),

// After
'script-src': [
  "'self'",
  // Allow inline scripts for Next.js in both dev and prod
  isDevelopment ? "'unsafe-inline'" : '',
  isDevelopment ? "'unsafe-eval'" : '',
  !isDevelopment ? "'unsafe-inline'" : '',  // Added for production
  // Vercel services
  'https://va.vercel-scripts.com',
  'https://vercel.live',  // Added for Vercel Live
  'https://www.googletagmanager.com',
  'https://www.google-analytics.com'
].filter(Boolean),
```

**Added Vercel Live support**:

```typescript
'connect-src': [
  "'self'",
  'https://*.tribeupdate.com',  // Custom domain
  'https://vercel.live',  // Added
  // ... other sources
],

'frame-src': [
  "'self'",
  'https://vercel.live',  // Added for Vercel feedback widget
],
```

### 2. Created Favicon

**File**: [`public/icon.svg`](../public/icon.svg)

Created a simple SVG icon with the Tribe brand color (#f3841c) to prevent 404 errors.

**Updated Metadata**: [`src/app/layout.tsx`](../src/app/layout.tsx:15-21)

```typescript
icons: {
  icon: [
    { url: '/favicon.ico', sizes: 'any' },
    { url: '/icon.svg', type: 'image/svg+xml' }
  ],
  apple: '/apple-icon.png'
},
```

## Security Considerations

### Why `'unsafe-inline'` for Scripts?

While `'unsafe-inline'` reduces security, it's necessary for Next.js 15 because:

1. **Framework Requirement**: Next.js uses inline scripts for hydration
2. **No Nonce Support**: Next.js 15 doesn't yet support CSP nonces in production
3. **Trade-off**: We maintain other security measures:
   - Strict `default-src 'self'`
   - Whitelisted script sources only
   - No `'unsafe-eval'` in production
   - XSS prevention through input sanitization

### Better Alternatives (Future)

For better security in the future:

1. **CSP Nonces**: When Next.js supports nonces, use them instead of `'unsafe-inline'`
   ```typescript
   'script-src': ["'self'", `'nonce-${nonce}'`, ...sources]
   ```

2. **Script Hashes**: Hash specific inline scripts and whitelist them
   ```typescript
   'script-src': ["'self'", "'sha256-...'", ...sources]
   ```

3. **Report-Only Mode**: Monitor violations before enforcing
   ```typescript
   'Content-Security-Policy-Report-Only': csp
   ```

## Testing

All quality checks passed:

```bash
# Linting
npm run lint
✔ No ESLint warnings or errors

# Tests
npm test
Test Suites: 20 passed, 20 total
Tests:       397 passed, 397 total

# Build
npm run build
✔ Build completed successfully
```

## Deployment

After deployment, verify:

1. **No CSP Errors**: Check browser console for CSP violations
2. **Scripts Load**: Verify Next.js hydration works correctly
3. **Vercel Analytics**: Confirm analytics scripts load
4. **Favicon**: Check that favicon.ico or icon.svg loads without 404

## Monitoring

Monitor CSP violations in production:

1. **Browser Console**: Check for CSP errors in DevTools
2. **Error Tracking**: Set up CSP reporting endpoint (optional)
3. **Vercel Logs**: Review deployment logs for issues

### Setting Up CSP Reporting (Optional)

To collect CSP violation reports:

1. Create reporting endpoint: `/api/csp-report`
2. Set environment variable: `CSP_REPORT_URI=https://your-domain.com/api/csp-report`
3. CSP will automatically include `report-uri` directive

## References

- [Next.js CSP Documentation](https://nextjs.org/docs/app/building-your-application/configuring/content-security-policy)
- [MDN CSP Guide](https://developer.mozilla.org/en-US/docs/Web/HTTP/CSP)
- [CSP Evaluator](https://csp-evaluator.withgoogle.com/)
- [Content Security Policy Spec](https://www.w3.org/TR/CSP/)

## Related Files

- [CSP Configuration](../src/lib/security/csp.ts)
- [Security Middleware](../src/middleware.ts)
- [App Layout](../src/app/layout.tsx)
- [Next Config](../next.config.js)

## Changelog

### 2025-10-02
- Added `'unsafe-inline'` for production script-src (Next.js 15 requirement)
- Added Vercel Live domain to script-src, connect-src, and frame-src
- Added custom domain to connect-src
- Created SVG icon placeholder
- Updated app metadata with icons configuration
- Documented security considerations and future improvements

---

**Note**: This is a temporary solution until Next.js provides better CSP support with nonces or hashes. Monitor the Next.js roadmap for CSP improvements.
